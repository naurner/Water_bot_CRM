# Обновление системы уведомлений

## Что изменилось

Система уведомлений переписана с использования JobQueue на встроенные возможности Telegram API для отложенных сообщений (Scheduled Messages).

## Основные изменения

### 1. reminder_service.py
- **Метод `schedule_reminders`**: теперь использует параметр `schedule_date` в `bot.send_message()` для создания отложенных сообщений
- **Новый метод `cancel_reminders_for_order`**: отменяет запланированные сообщения по ID заказа, получая ID сообщений из базы данных
- **Метод `cancel_scheduled_messages`**: удаляет запланированные сообщения по их ID через `bot.delete_message()`

### 2. database.py
- Добавлены поля в заголовки заказов:
  - `Morning Reminder ID` - ID утреннего напоминания
  - `Pre-delivery Reminder ID` - ID напоминания за 30 минут
- **Новый метод `update_order_reminder_ids`**: сохраняет ID запланированных сообщений
- **Новый метод `get_order_reminder_ids`**: получает ID запланированных сообщений для заказа
- Обновлен метод `_parse_order_row` для парсинга новых полей

### 3. main.py
- При создании заказа (`handle_time_selection`):
  - После планирования напоминаний сохраняются ID сообщений в БД
  - **Добавлена проверка минимум 4 часа**: заказ можно сделать не ранее чем за 4 часа до выбранного времени
- При отмене заказа (`confirm_cancel`):
  - Используется новый метод `cancel_reminders_for_order` вместо старого `cancel_reminders`
- При переносе заказа (`handle_reschedule_time`):
  - Отменяются старые напоминания через `cancel_reminders_for_order`
  - Создаются новые напоминания
  - Сохраняются новые ID сообщений в БД
  - **Добавлена проверка минимум 4 часа**: переносить можно только на время не ранее чем через 4 часа

## Преимущества новой системы

1. **Надежность**: Запланированные сообщения хранятся на серверах Telegram, не зависят от работы бота
2. **Точность**: Сообщения доставляются точно в указанное время
3. **Персистентность**: Даже при перезапуске бота сообщения будут доставлены
4. **Простота**: Не требуется поддержка JobQueue и её состояния
5. **Контроль времени**: Минимум 4 часа до заказа/переноса обеспечивает достаточно времени для подготовки

## Типы напоминаний

1. **Утреннее напоминание** - отправляется в 8:00 утра в день доставки
2. **Напоминание перед доставкой** - отправляется за 30 минут до времени доставки

## Ограничения по времени

⏱️ **Важно**: 
- При создании заказа доступны только временные слоты не ранее чем через 4 часа от текущего момента
- При переносе заказа также можно выбрать только слоты не ранее чем через 4 часа
- Отмена заказа возможна не менее чем за 4 часа до доставки

**Пример:**
- Текущее время: 14:00
- Доступные слоты на сегодня: 18:00, 18:30, 19:00 и далее
- Слоты 14:00-17:30 будут скрыты

## Формат хранения

В Excel файле `orders.xlsx` для каждого заказа хранятся:
- Колонка 10: `Morning Reminder ID` - ID сообщения утреннего напоминания
- Колонка 11: `Pre-delivery Reminder ID` - ID сообщения напоминания за 30 минут

## API Telegram

Используются следующие методы Telegram Bot API:
- `send_message(chat_id, text, schedule_date=timestamp)` - отправка отложенного сообщения
- `delete_message(chat_id, message_id)` - отмена запланированного сообщения

## Примечания

⚠️ **Важно**: Функция отложенных сообщений (Scheduled Messages) доступна только для личных чатов и каналов, где бот является администратором. В обычных чатах эта функция может работать по-другому.

Если Telegram Bot API не поддерживает параметр `schedule_date` для вашего типа бота, система автоматически логирует ошибки, но продолжает работу.

## Обратная совместимость

Старые заказы без сохраненных ID напоминаний будут продолжать работать. При попытке отмены напоминаний для таких заказов просто не будет найдено ID сообщений для удаления.
